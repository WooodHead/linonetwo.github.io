---
layout: post
title: "级联GraphQL访问控制"
date: 2017-08-25 19:37:19 +0800
image: 'blog-author.jpg'
description: '一种构造多层 GraphQL API 来进行访问控制的方法'
main-class: 'backend'
color: '#827717'
tags:
- GraphQL
- Apollo
- WIP
categories: Journal
twitter_text:
introduction: ''
---
# 级联GraphQL访问控制

越来越多的数据库开始暴露 GraphQL 接口，从搞关系式数据库的 ```postgraphql``` 到弄图论数据库的 ```Neo4j-GraphQL Extension```。
  
你只需要用 GraphQL Schema Defination Language [描述出你的业务模型](https://neo4j.com/developer/graphql/)，一个 GraphQL API 就从数据库上暴露了出来，接下来只需要在客户端写一些 query 就可以在很短的时间内搞定前后端交互……

等等，这样难道不像把 SQL 语句从前端发送到后端执行一样傻么？
  
我们还缺少一个鉴权层，缺少一个挡在数据库前的网关，至少执行以下两个步骤：

1. 确认用户身份，可信地把用户定位到图里的一个节点
1. 给客户端发来的 GraphQL 查询加上鉴权操作，判断用户节点是否拥有查看他想看的每个节点的权限

这两个步骤一定得在服务端完成，不然用户就可以构造出 ```AND 1=1``` 这样的伎俩来欺骗我们。

也就是说，我们需要一个能反向代理、并对 query 做一定修改的，级联的 GraphQL 网关。

## 权限管理模型

为了方便，我参考 Palantir 的访问控制模型 [[2]](#2) ，并以 Neo4J 作为存储数据的后端。

## 参考

### [<span id="1">Composing public GraphQL APIs Discussion</span>](https://github.com/graphql/graphql-js/issues/490)

### [<span id="2">Palantir Access Control</span>](https://www.slideshare.net/palantirtech/palantir-access-control)
