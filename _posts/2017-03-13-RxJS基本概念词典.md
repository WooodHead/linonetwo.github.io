---
layout: post
title: "RxJS基本概念词典"
date: 2017-03-13 17:44:19 +0800
image: 'blog-author.jpg'
description: '澄清Subject、Observer、Observerable等概念'
main-class: 'frontend'
color: '#66CCFF'
tags:
- Rx
- WIP
categories: Review
twitter_text:
introduction: 'Rx 中的态射大多是前端用 lodash 时常见的，但 Rx 中的函子却容易令我这样的新手前端感到迷惑，就此整理'
---
# RxJS基本概念词典

本文将介绍 Rx 中的 Subject、Observer、Observerable 等函子在生产中的可能用法，而不介绍[amb算子](http://rxmarbles.com/#amb)这样的态射，因为介绍态射的文章明显更多。
  
为方便了解基本概念，我提供了一些特性示例，放入一个 js 文件即可执行。在执行之前需要在文件夹里 ```npm i rxjs bluebird babel-core babel-polyfill```，然后以 ```node -r "./node_modules/babel-core/register" -r "./node_modules/babel-polyfill/lib/index.js"``` 运行。

## Observable Observer

Observable 乃可观察对象，用 create 函数创建。它是一个流，类似于可以异步地 resolve 多个值的 Promise。向流里传值的工作用创建时传给你的 observer 对象来做。
  
Observer 乃对可观察对象的观察者，可以是一个很简单的、只包含三个键值对的对象，把它传给 subscribe 函数后可以用它观察到 Observable 流中的值。

```javascript
// 特性示例
import Promise from 'bluebird';
import { Observable } from 'rxjs';

const observable = Observable.create(async (observer) => {
  // 向流里传值的工作用传给你的 observer 对象来做
  // 此处我们同步地传两个值
  observer.next(1);
  observer.next(2);
  // 再异步地传一个值
  await Promise.delay(1000);
  observer.next(3);
  observer.complete('complete!');
  // Error 与 complete 都类似于终结符（EOF、终止密码子），用了 complete 就不能再接收到 observer.error('error!');
  observer.error('error!');
});

console.log('before1');
// 订阅以得到流中的值，自动创建 Observer
observable.subscribe(
  nextValue => console.log(`First function get a value:  ${nextValue}`),
  error => console.error(`Second function get an error: ${error}`),
  notification => console.log(`Observer got a complete notification, but undefined is passed in: ${notification}`)
);
console.log('after1');
// 手动创建一个 Observer，一个只包含三个键值对的对象，并用它来订阅流
console.log('before2');
observable.subscribe({
  next: nextValue => console.log(`First function get a value:  ${nextValue}`),
  error: error => console.error(`Second function get an error: ${error}`),
  complete: notification => console.log(`Observer got a complete notification, but undefined is passed in: ${notification}`)
});
console.log('after2');
// before1
// First function get a value:  1
// First function get a value:  2
// after1

// before2
// First function get a value:  1
// First function get a value:  2
// after2

// First function get a value:  3
// Observer got a complete notification, but undefined is passed in: undefined
// First function get a value:  3
// Observer got a complete notification, but undefined is passed in: undefined

```

服务端用 Express 将传入的 HTTP request 转化为流:

```javascript
// 服务端用法
import { Observable } from 'rxjs';

const observable = Observable.create((observer) => {

  expressApp.get('/api/v1/xxxxxx/:id', (req, res) => {
    try {
      const id: number = req.params.id;
      const { limit }: NotificationQuery = req.query;
      // 搞个流出来
      observer.next({ id, limit });
      res.send({ code: 0, data: result });
    } catch (error) {
      observer.error('error!');
      res.send({ code: -1, message: error.toString() });
    }
  });

});
```


## Subject

Subject 是一种中间节点，可以观察别的 Observerable，可以被别的 Observer 观察。

```javascript
// 特性示例
import { Subject } from 'rxjs';

const subject = new Subject();

console.log('before1');
// 先订阅这个流
subject.subscribe(
  nextValue => console.log(`First function get a value:  ${nextValue}`),
  error => console.error(`Second function get an error: ${error}`),
  notification => console.log(`Observer got a complete notification, but undefined is passed in: ${notification}`)
);
console.log('after1');
// 然后可以往流里塞值
subject.next(1);
// 可以将 next 函数传作它用，但一定要记得 bind this，不然会爆 Cannot read property 'closed' of undefined
const putValue = subject.next;
subject::putValue(2);

console.log('before2');
subject.subscribe({
  next: nextValue => console.log(`First function get a value:  ${nextValue}`),
  error: error => console.error(`Second function get an error: ${error}`),
  complete: notification => console.log(`Observer got a complete notification, but undefined is passed in: ${notification}`)
});
console.log('after2');

```